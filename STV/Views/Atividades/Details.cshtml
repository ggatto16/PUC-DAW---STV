@model STV.Models.Atividade

@{
    ViewBag.Title = "Atividade";
}

<script>var trSelecionada = 'tr_@ViewBag.QuestaoSelecionada';</script>

<ol class="breadcrumb">
    <li><a href="~/Cursos/Details/@Model.Unidade.Curso.Idcurso">@Model.Unidade.Curso.Titulo</a></li>
    <li><a href="~/Cursos/Details/@Model.Unidade.Curso.Idcurso?Idunidade=@Model.Unidade.Idunidade">@Model.Unidade.Titulo</a></li>
    <li class="active">Detalhes da Atividade</li>
</ol>

<h2>Atividade</h2>

<div class="col-md-6">
    <div>
        <hr />
        <dl class="dl-horizontal">
            <dt>
                @Html.DisplayNameFor(model => model.Descricao)
            </dt>
            <dd>
                @Html.DisplayFor(model => model.Descricao)
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.Valor)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.Valor)
            </dd>
            <dt>
                @Html.DisplayNameFor(model => model.DataAbertura)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.DataAbertura)
            </dd>
            <dt>
                @Html.DisplayNameFor(model => model.DataEncerramento)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.DataEncerramento)
            </dd>

        </dl>
    </div>
    <p>
        @Html.ActionLink("Alterar", "Edit", new { id = Model.Idatividade }, new { @class = "btn btn-primary" })
        <a href="@Url.Action("Details", "Cursos", new { id = Model.Unidade.Idcurso, Idunidade = Model.Idunidade })" class="btn btn-default grid-control" data-toggle="tooltip" title="Voltar para Listagem">Voltar</a>
    </p>

    <hr />


    <h4>Questões</h4>

    <p>
        @if (Model.DataAbertura < DateTime.Now)
        {
            <input type="button" class="btn-sm btn-success" value="Adicionar" disabled="disabled" data-toggle="tooltip" title="A atividade está aberta. Não é possível alterar." />
        }
        else
        {
            Html.ActionLink("Adicionar", "Create", "Questoes", new { Idatividade = Model.Idatividade }, new { @class = "btn-sm btn-success" });

        }
    </p>

    <table class="table table-striped">
        @foreach (var questao in Model.Questoes.OrderBy(x => x.Numero))
        {
            var questaoSelecionada = string.Empty;
            var tooltip = string.Empty;
            if (ViewBag.QuestaoSelecionada == questao.Idquestao)
            {
                questaoSelecionada = "info";
            }
            else
            {
                questaoSelecionada = string.Empty;
            }
            if (questao.IdalternativaCorreta == null)
            {
                tooltip = "Atenção! Questão sem alternativas não será publicada.";
                questaoSelecionada = "danger";
            }
            <tr class="@questaoSelecionada" id="tr_@questao.Idquestao" data-toggle="tooltip" title="@tooltip">
                <td>
                    @Html.DisplayFor(modelItem => questao.Numero)
                </td>
                <td>
                    @Ajax.ActionLink((questao.Descricao.Length > 50) ? questao.Descricao.Substring(0, 50) + "..." : questao.Descricao, "CarregarAlternativas", "Questoes", new { Idquestao = questao.Idquestao }, new AjaxOptions { UpdateTargetId = "Alternativas", InsertionMode = InsertionMode.Replace, HttpMethod = "Get", OnBegin = "onBeginAjax", OnComplete = "debugger; SetInfoClass(tr_" + questao.Idquestao + ")" })
                </td>
                <td>
                </td>
                    <a href="#" class="btn-sm btn-danger btn-excluir" data-toggle="tooltip" title="Ver questão completa">
                        <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                    </a>
                <td>
                    <a href="@Url.Action("Edit", "Questoes", new { id = questao.Idquestao })" class="btn-sm btn-primary btn-alterar" data-toggle="tooltip" title="Alterar">
                        <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                    </a>
                </td>
                <td>
                    <a href="@Url.Action("Delete", "Questoes", new { id = questao.Idquestao })" class="btn-sm btn-danger btn-excluir" data-toggle="tooltip" title="Excluir">
                        <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                    </a>
                </td>
                @if (questaoSelecionada == "danger")
                {
                    <td><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span></td>
                }
            </tr>
        }
    </table>
</div>


<div class="col-md-6">
    <div id="Alternativas"></div>
</div>

@section scripts {

    @Scripts.Render("~/bundles/jqueryval")

    <script>

        $(document).ready(function () {
            @if (ViewBag.QuestaoSelecionada != null)
            {
                <text>
            var url = '@Url.Action("CarregarAlternativas", "Questoes", new { Idquestao = ViewBag.QuestaoSelecionada })';
            $.post(url, null, function (data) { $('#Alternativas').html(data); });
            </text>
            }
        });

        function SetInfoClass(tr) {
            try {
                $('#' + trSelecionada).removeClass('info');
                tr.classList.add('info');
                trSelecionada = tr.id;
                onCompleteAjax();
            }
            catch (err) {
                onCompleteAjax();
            }
        };
    </script>
}